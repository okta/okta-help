<?xml version="1.0" encoding="utf-8"?>
<html MadCap:onlyLocalStylesheets="False" MadCap:searchable="True" xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" MadCap:fileTags="Tags/okta-authors.Patrick Calnan">
    <head>
        <link rel="canonical" href="https://help.okta.com/oag/en-us/Content/Topics/Access-Gateway/add-app-kerberos-ts.htm" /><title>[%=Heading.Level1%] | Okta</title>
        <link href="" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <h1> Kerberos application troubleshooting and best practices</h1>
        <div>
            <p>Learn about the best practices to follow and how to configure and troubleshoot common Kerberos application issues. </p>
            <ul>
                <li>
                    <MadCap:xref href="#Troubles">Troubleshooting Kerberos timeout</MadCap:xref>
                </li>
                <li>
                    <MadCap:xref href="#Troubles2">Troubleshoot Parent-Child/Sibling AD Domain</MadCap:xref>
                </li>
                <li>
                    <MadCap:xref href="#Troubles3">Troubleshooting 401 Authorization Error</MadCap:xref>
                </li>
                <li>
                    <MadCap:xref href="#Execute">Should you run setspn for each IWA app that you add in [%=okta-feature-names.Access Gateway%]?</MadCap:xref>
                </li>
                <li>
                    <MadCap:xref href="#Always">Always validate user and server using the Kerberos Simulator</MadCap:xref>
                </li>
                <li>
                    <MadCap:xref href="#Ensure2">Enable Kerberos authentication on the IIS server</MadCap:xref>
                </li>
                <li>
                    <MadCap:xref href="#Ensure">Verify the IWA_USERNAME header is valid</MadCap:xref>
                </li>
                <li>
                    <MadCap:xref href="#Supporti">Supporting Kerberos on sibling domains</MadCap:xref>
                </li>
            </ul>
            <h2><a name="Troubles"></a>Troubleshooting Kerberos timeout</h2>
            <p>Problem: Timeouts occur while accessing the Kerberos KDC. These return errors similar to:</p>
            <p>
                <img src="../../Resources/Images/access-gateway/add-app-kerberos-ts-timeout.png" id="img_new" class="thumbnail" />
            </p>
            <p>Try the following solution:</p>
            <ol>
                <li>
                    <p>Ensure that the firewall ports TCP/88 and UDP/88 are open between <MadCap:variable name="okta-feature-names.Access Gateway" /> and the Kerberos server (Active Directory running as an <MadCap:variable name="okta-feature-names.Access Gateway" /> Kerberos service).</p>
                </li>
                <li>
                    <p>Ensure that the <span class="uicontrol">use kdc host</span> option is enabled and the associated Active Directory server is entered as IP&#160;address.</p>
                </li>
            </ol>
            <div>
                <h2><a name="Troubles2"></a>Troubleshoot Parent-Child/Sibling AD Domain</h2>
                <p>Problem: Organization has an AD Forest with Parent and multiple children domain. The IIS/SharePoint server instance is part of a child domain.</p>
                <p>How to configure so that Kerberos authentication works with OAG</p>
                <p>Try the following solution:</p>
                <ul>
                    <li>
                        <p>Create the <MadCap:variable name="okta-feature-names.Access Gateway" /> SPN account in the child domain of the IIS server. This solutions works because by default all domains in a Active Directory forest trust each other.</p>
                        <p> Otherwise, follow the single AD domain instructions.</p>
                        <div class="noteOkta">
                            <p class="noteContent">If you create the SPN account in the parent domain, the SPN cannot see the services in the children domain.</p>
                        </div>
                    </li>
                </ul>
            </div>
            <div>
                <h2><a name="Troubles3"></a>Troubleshooting 401 Authorization Error</h2>
                <p>Problem: 401 authorization error in <MadCap:variable name="okta-feature-names.Access Gateway" /> protected application.</p>
                <p>Typically one of three things is wrong:</p>
                <ol>
                    <li>IIS does not have Kerberos provider enabled. Verify in IIS that the Kerberos provider is enabled for authentication.</li>
                    <li>
                        <p>Not sending a valid username in IWA_USERNAME header. See <MadCap:xref href="#Ensure">Ensure IWA_USERNAME header is set properly</MadCap:xref>.</p>
                    </li>
                    <li>The protected hostname isn't the same value as the IIS windows hostname.Validate that the application&#160;<span class="uicontrol">Protected Web Resource</span> field matches the IIS windows hostname. </li>
                </ol>
            </div>
            <div>
                <h2><a name="Always"></a>Always validate user and server using the Kerberos Simulator</h2>
                <p>Best practice: When configuring the Kerberos service in <MadCap:variable name="okta-feature-names.Access Gateway" /> validate first.</p>
                <p>For example:</p>
                <p>
                    <img src="../../Resources/Images/access-gateway/add-app-kerberos-ts-validate-realm.png" id="img_new" class="thumbnail" />
                </p>
                <div class="noteOkta">
                    <p class="noteContent">Ensure that the Kerberos app <span class="uicontrol">Protected Web Resource</span> matches the value tested in the Kerberos simulator.</p>
                </div>
            </div>
            <div>
                <h2><a name="Execute"></a>Should you run setspn for each IWA app that you add in <MadCap:variable name="okta-feature-names.Access Gateway" />?</h2>
                <p>Problem: Should you run <span class="code">setspn</span> for every IWA app that you add in <MadCap:variable name="okta-feature-names.Access Gateway" />?</p>
                <ul>
                    <li>No. However, you should add each IIS server to the service account for each domain.</li>
                </ul>
            </div>
            <div>
                <h2><a name="Ensure2"></a>Enable Kerberos authentication on the IIS server</h2>
                <p>Enable Kerberos authentication on the IIS&#160;server.&#160;For example:</p>
                <p>
                    <img src="../../Resources/Images/access-gateway/add-app-kerberos-ts-enable-kb-on-ispng.png" id="img_new" class="thumbnail" />
                </p>
            </div>
            <div>
                <h2><a name="Ensure"></a>Verify the IWA_USERNAME header is valid</h2>
                <p>When configuring the <span class="code">IWA_USERNAME</span> header attribute:</p>
                <ul>
                    <li>Initially test with a static value.</li>
                    <li>Ensure that the domain name is in all UPPERCASE.</li>
                </ul>
                <p>For example:</p>
                <p>
                    <img src="../../Resources/Images/access-gateway/add-app-kerberos-ts-test-static-value.png" id="img_new" class="thumbnail" />
                </p>
            </div>
            <div>
                <h2><a name="Supporti"></a>Support Kerberos on sibling domains</h2>
                <p>Problem: There is a parent domain and multiple children domains where each child domain has attached IIS or SharePoint servers. There must be SSO between AD domains. A best practice is to have all of the IIS and SharePoint servers attached to the parent domain. If this isn't possible, then we need to create multiple realms in <MadCap:variable name="okta-feature-names.Access Gateway" /> with unique Service Principle Names (SPNs).</p>
                <p>For example:</p>
                <ol>
                    <li>Domain 1 - Service Principle Name - Follow the instructions from the <MadCap:variable name="okta-feature-names.Access Gateway" /> console wizard.<br />Domain 1 - Keytab<br />Follow the instructions from <MadCap:variable name="okta-feature-names.Access Gateway" /> console wizard.</li>
                    <li>Domain 2- Service Principle Name - Follow the instructions from OAG console wizard, changing the “host/” value to something unique.<br />Domain 2 - Keytab<br />Follow the instructions from <MadCap:variable name="okta-feature-names.Access Gateway" /> console wizard except change the “host/” value to something unique.</li>
                </ol>
                <p>For example:</p><span class="codeblock">setspn -s host/gwelvis.adlab.com ELVIS\oagelvis
ktpass /princ host/gwelvis.adlab.com@ELVIS.ADLAB.COM /mapuser oagelvis@elvis.adlab.com /out c:\oagelvis.keytab /rndPass /pType KRB5_NT_PRINCIPAL /crypto All</span>
            </div>
            <MadCap:snippetBlock src="../../Resources/Snippets/access-gateway/app-ts-related-topics.flsnp" />
        </div>
    </body>
</html>