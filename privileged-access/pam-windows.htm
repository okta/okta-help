<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head>
    </head>
    <body>
        <h1>Windows Internals</h1>
        <h2>Before you begin</h2>
        <ul>
            <li>
                <MadCap:xref href="tool-setup/install-agent.htm">Install the [%=okta-feature-names.Okta Privileged Access%] server agent</MadCap:xref>
            </li>
            <li>
                <MadCap:xref href="tool-setup/install-client.htm">Install the [%=okta-feature-names.Okta Privileged Access%] client</MadCap:xref>
            </li>
        </ul>
        <div>
            <p>After you install the  server agent and enroll the server, the   server agent creates local server accounts for all  <MadCap:variable name="okta-feature-names.Okta Privileged Access" /> users that are part of the related project. On
Windows, these accounts are disabled unless a connection is active.</p>
            <p>On Windows, a related access broker process is responsible for proxying Remote Desktop Protocol (RDP) connections. Using port 4421, this process is required to allow successful RDP connections to the server. For more information, see <MadCap:xref href="../Adv_Server_Access/docs/sftd-configure.htm#access">Configure and use the [%=okta-feature-names.ScaleFT%] server agent</MadCap:xref>.</p>
        </div>
        <div>
            <h2>Server Configuration</h2>
            <p>On Windows, the  <MadCap:variable name="okta-feature-names.Okta Privileged Access" /> server agent runs under the <span class="code">LocalSystem</span> account. You can control the <MadCap:variable name="okta-feature-names.ScaleFT" /><span class="disableGlossary">server agent</span> by manually creating a configuration file. On Windows, this file must be manually created at <span class="code">C:\Windows\System32\config\systemprofile\AppData\Local\scaleft\sftd.yaml</span>. For details, see <a href="https://help.okta.com/asa/en-us/Content/Topics/Adv_Server_Access/docs/sftd-configure.htm" target="_blank">Configure the server agent</a>.</p>
            <div MadCap:conditions="Primary.do-not-publish">
                <h3>
                    <MadCap:annotation MadCap:createDate="2022-02-03T14:30:11.9326859-05:00" MadCap:creator="Isaac" MadCap:initials="ID" MadCap:comment="This will probably need to be split into a MS specifc topic in the AWS node." MadCap:editor="Isaac" MadCap:editDate="2022-02-03T14:30:39.4234739-05:00">AWS </MadCap:annotation>Configuration</h3>
                <p>Alternatively, you can associate an AWS account with an <MadCap:variable name="okta-feature-names.ScaleFT" /> project.</p>
                <p>You can install the <MadCap:variable name="okta-feature-names.ScaleFT" /> server agent on AWS with the following powershell script.</p>
                <div class="noteOkta">
                    <p class="noteContent">You must replace the value of <code>$enrollment_token</code> with an actual <MadCap:variable name="okta-feature-names.ScaleFT" /> enrollment token. See <MadCap:xref href="../Adv_Server_Access/docs/setup/enrolling-a-server.htm">Enroll a server</MadCap:xref>. </p>
                </div>
                <p>If you have associated an AWS account with your
 <MadCap:variable name="okta-feature-names.ScaleFT" /> project, you can omit the first half of the script which is responsible for writing the enrollment token.</p><span class="codeblock">&lt;powershell&gt;
# Create the Enrollment Token
$enrollment_token = "REPLACE_WITH_ENROLLMENT_TOKEN"
$enrollment_token_path = "C:\windows\system32\config\systemprofile\AppData\Local\scaleft\enrollment.token" New-Item -ItemType directory -Path (Split-Path $enrollment_token_path -Parent) $enrollment_token | Out-File $enrollment_token_path -Encoding "ASCII"
# Install  <MadCap:variable name="okta-feature-names.ScaleFT" /> server agent
$installer_url = "https://dist.scaleft.com/server-tools/windows/latest/ScaleFT-Server-Tools-latest.msi"
$installer_path = [System.IO.Path]::ChangeExtension([System.IO.Path]::GetTempFileName(), ".msi")
(New-Object System.Net.WebClient).DownloadFile($installer_url, $installer_path)
msiexec.exe /qb /I $installer_path
&lt;/powershell&gt;</span>
            </div>
        </div>
        <div MadCap:conditions="Primary.do-not-publish">
            <h2>Connection and authentication</h2>
            <p>When you open an RDP connection to a Windows server, the  <MadCap:variable name="okta-feature-names.Okta Privileged Access" /> client performs several actions involving th access broker service running on the server: </p>
            <ol>
                <li>The client communicates with <MadCap:variable name="okta-feature-names.Okta Privileged Access" /> to receive short-lived credentials. Depending on your network topology, the client may establish an encrypted tunnel through any intermediate bastions or gateway servers.</li>
                <li>The client connects to the  access broker process running on the server  and authenticates using the short-lived
certificates.</li>
                <li>The client authenticates the host certificate against information provided by <MadCap:variable name="okta-feature-names.Okta Privileged Access" />. This helps defend against man-in-the-middle attacks.</li>
                <li>The client requests access to the related account on the server. On the server, the access broker sends a request to the server agent
to enable the account.</li>
                <li>The client negotiates a proxied RDP connection via the access broker.</li>
                <li>The client starts a TCP server on a random port
on the client device. Communications are proxied through the access broker to the RDP service running on the server.</li>
                <li>The RDP client connects to the local TCP port and is forwarded to the RDP service on the server.</li>
            </ol>
            <p>The RDP client automatically authenticates as the user.</p>
        </div>
        <div>
            <h2>Server Connections</h2>
            <p>You can open an RDP connection with the <code>rdp</code> command (<code>sft rdp &lt;server-name&gt;
</code>). </p>
            <div class="noteOkta">
                <p class="noteContent">When you connect  with the Windows RDP client, the title bar may display the loopback IP address (for example, 127.0.0.1).</p>
            </div>
        </div>
        <div>
            <h2>Paths</h2>
            <p>Information related to the <MadCap:variable name="okta-feature-names.ScaleFT" /> server agent installation is stored within the AppData\Local\ folder.</p>
            <ul>
                <li>State directory:&#160;<code>C:\Windows\System32\config\systemprofile\AppData\Local\scaleft</code></li>
                <li>Configuration file: <code>C:\Windows\System32\config\systemprofile\AppData\Local\scaleft\sftd.yaml</code><br />Note: You must manually create the configuration file.</li>
                <li>Log directory: <code>C:\Windows\System32\config\systemprofile\AppData\Local\scaleft\Logs</code><br />Note: Log files are rotated after 5MB and only the 10 most recent log files are kept.</li>
                <li>Enrollment token: <code>C:\Windows\System32\config\systemprofile\AppData\Local\scaleft\enrollment.token</code></li>
            </ul>
        </div>
        <h2>Related topics</h2>
        <ul>
            <li>
                <MadCap:xref href="server-agent/pam-enroll-a-server.htm">Server Enrollment</MadCap:xref>
            </li>
            <li>
                <MadCap:xref href="server-agent/pam-configure-server-agent.htm">Configure the [%=okta-feature-names.Okta Privileged Access%] server agent</MadCap:xref>
            </li>
            <li><a href="https://help.okta.com/asa/en-us/Content/Topics/Adv_Server_Access/docs/sftd-configure.htm" target="_blank">Configure and use the <MadCap:variable name="workflows_connectors.Advanced Server Access" /> server agent</a>
            </li>
        </ul>
    </body>
</html>