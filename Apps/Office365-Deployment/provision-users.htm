<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd"
      MadCap:fileTags="Tags/okta-authors.Mark Cowan">
   <head>
      <title>[%=Heading.Level1%] | Okta</title>
      <meta name="description"
            content="Explains different provisioning types and how to configure them."/>
   </head>
   <body>
      <h1>Provision users to Office 365</h1>
      <p>You can create, update, and deprovision users in Office 365 from your Okta org. You can import users from different source directories into Okta and provision them in Office 365 using profile mappings.</p>
      <h2>Before you begin
        </h2>
      <ul>
         <li>Complete <MadCap:xref href="configure-sso.htm">Configure single sign on for Office 365</MadCap:xref>.</li>
         <li>Disable the Microsoft MFA for the Office 365 admin account you’re using for WS-Federation. If the MFA is enabled, it can break provisioning and single sign on set-ups in Okta.</li>
         <li>
            <MadCap:snippetBlock src="../Apps-Snippets/bring-users-in-okta.flsnp"/>
         </li>
         <li>
            <p>Decide the type of provisioning, depending on your provisioning needs. See <MadCap:xref href="../Office365/References/provisioning-types.htm">Provisioning options for Office 365</MadCap:xref>.</p>
         </li>
      </ul>
      <h2>Start this procedure</h2>
      <p>To provision users in Office 365, you need to:</p>
      <p>
         <MadCap:xref href="#1.">1. Set up Okta → Office 365 provisioning</MadCap:xref>
      </p>
      <p>
         <MadCap:xref href="#2.">2. Map profile attributes Okta → Office 365</MadCap:xref>
      </p>
      <p>
         <MadCap:xref href="#3.">3. Test provisioning</MadCap:xref>
      </p>
      <h3>
         <a name="1."/>1. Set up Okta to Office 365 provisioning</h3>
      <p>You can automate provisioning tasks by enabling API integration and configuring settings for different user life cycle stages.</p>
      <h4>1.1. Enable API integration</h4>
      <p>Office 365 requires a token to authenticate against the Microsoft API. This allows Okta to implement provisioning in Office 365.</p>
      <p MadCap:conditions="MultiProdPublish.Classic">
         <img src="../../../Resources/Images/Office365/Office365_Provisioning_Tab_Unconfigured.png"
              class="thumbnail"/>
      </p>
      <p MadCap:conditions="MultiProdPublish.OIE">
         <img src="../../../Resources/Images/Office365/OIE/prov-enbl-api.png"
              class="thumbnail"/>
      </p>
      <ol>
         <li>Go to <span class="menucascade">
               <span class="uicontrol">Office 365</span>
               <span class="uicontrol">Provisioning</span>
               <span class="uicontrol">API Integration</span>
               <span class="uicontrol">Configure API Integration</span>
            </span>.</li>
         <li>Check <span class="uicontrol">Enable API Integration</span>.</li>
         <li>
            <p>Click <span class="uicontrol">Authenticate with Microsoft Office 365</span>. You are redirected to the Microsoft Azure login page.</p>
            <ol style="list-style-type: lower-alpha;">
               <li>
                  <p>Log into your Microsoft Azure account.</p>
               </li>
               <li>
                  <p>Read and accept the requested permissions.</p>
               </li>
               <li>
                  <p>Upon accepting the scopes in the Microsoft Azure portal, you will be redirected back to Okta.</p>
               </li>
            </ol>
         </li>
         <li>Enter your Office 365 Global Administrator credentials.</li>
         <li>
            <p>To import groups now, check <span class="uicontrol">Import Groups</span>.</p>
            <p>You can import groups later after finishing provisioning. See <MadCap:xref href="../Office365/Skip_Group_Import_Office365.htm">Skip importing groups during Office 365 user provisioning</MadCap:xref>.</p>
         </li>
         <li>Click <span class="uicontrol">Test API Credentials</span>.</li>
         <li>Save the credentials once they are verified successfully.</li>
      </ol>
      <h4>1.2. Select provisioning type and settings</h4>
      <p>You can select provisioning and deprovisioning settings depending on the provisioning type you select.</p>
      <p MadCap:conditions="MultiProdPublish.Classic">
         <img src="../../../Resources/Images/Office365/o365-provision-types.png"
              MadCap:mediastyle="@media print { max-width: 60%; }"
              class="thumbnail"/>
      </p>
      <p MadCap:conditions="MultiProdPublish.OIE">
         <img src="../../../Resources/Images/Office365/OIE/prov-options.png"
              class="thumbnail"/>
      </p>
      <ol>
         <li>Go to <span class="menucascade">
               <span class="uicontrol">Office 365</span>
               <span class="uicontrol">Provisioning</span>
               <span class="uicontrol">To App</span>
               <span class="uicontrol">Edit</span>
            </span>.</li>
         <li>
            <p>Select <span class="uicontrol">Office 365 Provisioning Type</span>. See <MadCap:xref href="../Office365/References/provisioning-types.htm">Provisioning types for office 365</MadCap:xref>.</p>
            <p>For <span class="uicontrol">Universal Sync</span> only: Check <span class="uicontrol">Send full profile, contacts, and conference rooms from these AD instances</span> if you want to sync AD groups and resources.</p>
         </li>
         <li MadCap:conditions="MultiProdPublish.Classic">Enable or Disable other provisioning settings. See <MadCap:xref href="../Apps_Okta_Enhancements_Office_365_Integration.htm">Get started with Office 365 provisioning and deprovisioning</MadCap:xref>.</li>
         <li MadCap:conditions="MultiProdPublish.OIE">Enable or Disable other provisioning settings. See <MadCap:xref href="../Office365/o365-prov-main.htm">Get started with Office 365 provisioning and deprovisioning</MadCap:xref>.</li>
         <li>Click <span class="uicontrol">Save</span>.</li>
      </ol>
      <div class="noteOkta">
         <img src="../../../Resources/Images/assets/Icons/Notes/Help.png"
              class="noteImgFloat"
              title="Info"
              alt="Info"/>
         <p class="noteContent">Each user provisioned for Office365 has an attribute, <span class="code">StsRefreshTokensValidFrom</span>, which is a date that invalidates existing login sessions and refresh tokens when the user changes their password, requiring the user to log into their apps again. This attribute is automatically calculated and populated based on the Provisioning Type.</p>
         <ul>
            <li>
               <p>License Only or Profile Sync: The <span class="code">StsRefreshTokensValidFrom</span> attribute is set to the current date and time when the user changes their password in Okta.</p>
            </li>
            <li>
               <p>User Sync or Universal Sync: If the user is linked from Active Directory, the <span class="code">StsRefreshTokensValidFrom</span> attribute is set to the <span class="code">pwdLastSet </span>attribute in Active Directory. For all other users, the <span class="code">StsRefreshTokensValidFrom</span> attribute is set to the current date and time when the user changes their password in Okta.</p>
            </li>
         </ul>
      </div>
      <h3>
         <a name="2."/>2. Map profile attributes Okta to Office 365</h3>
      <p>Depending on where your users are sourced from, the username format can vary. For users to successfully sign into Office 365, their username for Office 365 must be in an email address format for the domain you are federating (<span class="userinput">username@yourfederated.domain</span>).</p>
      <div class="noteOkta">
         <img src="../../../Resources/Images/assets/Icons/Notes/Help.png"
              class="noteImgFloat"
              title="Important Note"
              alt="Important Note"/>
         <p class="noteContent">You must remap attributes whenever you make any changes to provisioning settings.</p>
      </div>
      <h4>Map username as-is</h4>
      <p>If your users already have their username in an email address format for the domain you are federating (<span class="userinput">username@yourfederated.domain</span>) format, you can map the email as-is.</p>
      <p MadCap:conditions="MultiProdPublish.Classic">
         <img src="../../../Resources/Images/Office365/o365-username-email.png"
              class="thumbnail"/>
      </p>
      <p MadCap:conditions="MultiProdPublish.OIE">
         <img src="../../../Resources/Images/Office365/OIE/cred-email.png"
              class="thumbnail"/>
      </p>
      <ol>
         <li>Go to <span class="menucascade">
               <span class="uicontrol">Office 365</span>
               <span class="uicontrol">Sign on</span>
               <span class="uicontrol">Edit</span>
            </span>.</li>
         <li>In <span class="menucascade">
               <span class="uicontrol">Credentials Details</span>
               <span class="uicontrol">Application username format</span>
            </span>, select <span class="uicontrol">Email</span>.</li>
         <li>Click <span class="uicontrol">Save</span>.</li>
      </ol>
      <h4>Map custom username</h4>
      <p>If your users are sourced from different directories or apps, their username format may vary. You can use Okta expression language to customize the username that will be passed on to Office 365.</p>
      <div MadCap:conditions="MultiProdPublish.Classic">
         <p>
            <img src="../../../Resources/Images/Office365/o365-username-custom.png"
                 class="thumbnail"
                 MadCap:mediastyle="@media print { max-width: 60%; }"/>
         </p>
         <ol>
            <li>Go to <span class="menucascade">
                  <span class="uicontrol">Office 365</span>
                  <span class="uicontrol">Sign on</span>
                  <span class="uicontrol">Edit</span>
               </span>.</li>
            <li>In <span class="menucascade">
                  <span class="uicontrol">Credentials Details</span>
                  <span class="uicontrol">Application username format</span>
               </span>, select <span class="uicontrol">Custom</span>.<p>Enter this expression in the provided text box:</p>
               <span class="userinput">String.substringBefore(user.email, "@") + "@yourfederated.domain"</span>
            </li>
            <li>Replace <span class="url">yourfederated.domain</span> with the domain you are federating.</li>
            <li>Enter an Okta user in the Preview box to check the result of the mapping.</li>
            <li>The resulting username should match the Office 365 username for the user.</li>
            <li>Click <span class="uicontrol">Save</span>.</li>
         </ol>
      </div>
      <div MadCap:conditions="MultiProdPublish.OIE">
         <p>
            <img src="../../../Resources/Images/Office365/OIE/cred-custom.png"
                 class="thumbnail"/>
         </p>
         <ol>
            <li>Go to <span class="menucascade">
                  <span class="uicontrol">Office 365</span>
                  <span class="uicontrol">Sign on</span>
                  <span class="uicontrol">Edit</span>
               </span>.</li>
            <li>In <span class="menucascade">
                  <span class="uicontrol">Credentials Details</span>
                  <span class="uicontrol">Application username format</span>
               </span>, select <span class="uicontrol">Custom</span>.<p>Enter this expression in the provided text box:</p>
               <span class="userinput">String.substringBefore(user.email, "@") + "@yourfederated.domain"</span>
            </li>
            <li>Replace <span class="url">yourfederated.domain</span> with the domain you are federating.</li>
            <li>Click <span class="uicontrol">Save</span>.</li>
         </ol>
      </div>
      <h4>Map email address</h4>
      <p>If your users’ email addresses do not reside in the domain you are federating, you can use Okta expression language to customize the email address that will be passed on to Office 365.</p>
      <p style="font-weight: bold;">Prerequisite</p>
      <p>Provisioning type should be selected to User Sync or Universal Sync. See <MadCap:xref href="../Office365/References/provisioning-types.htm">Provisioning options for Office 365</MadCap:xref>.</p>
      <div MadCap:conditions="MultiProdPublish.Classic">
         <p>
            <img src="../../../Resources/Images/Office365/o365-profile-editor-email-custom.png"
                 class="thumbnail"/>
         </p>
         <ol>
            <li>Go to <span class="menucascade">
                  <span class="uicontrol">Directory</span>
                  <span class="uicontrol">Profile Editor</span>
                  <span class="uicontrol">Microsoft Office 365 Mappings</span>
                  <span class="uicontrol">Okta to Microsoft Office 365</span>
               </span>. </li>
            <li>In the <span class="uicontrol">source.email</span> field, enter this expression:<br/>
               <span class="userinput">String.substringBefore(user.email, "@") + "@yourfederated.domain"</span>
            </li>
            <li>Replace <span class="userinput">yourfederated.domain</span> with the domain you are federating.</li>
            <li>Enter an Okta user in the Preview box to check the result of the mapping.</li>
            <li>The resultant email address should match the Office 365 email address for the user.</li>
            <li>Exit Preview and save mappings.</li>
            <li>Click <span class="uicontrol">Apply Updates Now</span>.</li>
         </ol>
      </div>
      <div MadCap:conditions="MultiProdPublish.OIE">
         <ol>
            <li>Go to <span class="menucascade">
                  <span class="uicontrol">Directory</span>
                  <span class="uicontrol">Profile Editor</span>
                  <span class="uicontrol">Apps</span>
                  <span class="uicontrol">Microsoft Office 365 Mappings</span>
                  <span class="uicontrol">Okta User to Microsoft Office 365</span>
               </span>. </li>
            <li>In the <span class="uicontrol">source.email</span> field, enter the expression:<br/>
               <span class="userinput">String.substringBefore(user.email, "@") + "@yourfederated.domain"</span>
            </li>
            <li>Replace <span class="userinput">yourfederated.domain</span> with the domain you are federating.</li>
            <li>Enter an Okta user in the Preview box to check the result of the mapping.</li>
            <li>The resultant email address should match the Office 365 email address for the user.</li>
            <li>Exit Preview and save mappings.</li>
            <li>Click <span class="uicontrol">Apply Updates Now</span>.</li>
         </ol>
      </div>
      <h3>
         <a name="3."/>3. Test provisioning</h3>
      <p>Ensure you have correctly configured provisioning by assigning Office 365 to test users in Okta and verifying they appear in your Microsoft tenant.</p>
      <p>Prerequisite: The <span class="uicontrol">Create Users</span> option  in Provisioning must be checked.</p>
      <p>In Okta:</p>
      <ol>
         <li>Open <span class="uicontrol">Assignment</span> tab of the Microsoft Office 365 app.</li>
         <li>Click <span class="uicontrol">Assign</span>.</li>
         <li>Assign appropriate Office 365 licenses to test users.</li>
         <li>Click <span class="uicontrol">Done</span>.</li>
      </ol>
      <p>In Microsoft Admin Center:</p>
      <ol>
         <li>Open the list of Active Users.</li>
         <li>Ensure all test users appear in the list with appropriate licenses.</li>
      </ol>
      <p>In Okta:</p>
      <ol>
         <li>Log into Okta as a test user.</li>
         <li>Ensure all Office 365 apps appear on the user dashboard.</li>
      </ol>
      <div class="noteOkta">
         <img src="../../../Resources/Images/assets/Icons/Notes/Help.png"
              class="noteImgFloat"
              title="Info"
              alt="Info"/>
         <p class="noteHeading">Note</p>
         <p class="noteContent">
            If you have selected the <span class="uicontrol">User Sync</span> or <span class="uicontrol">Universal Sync</span> provisioning type, all users irrespective of where their profile is sourced from, appear as <span class="uicontrol">Synced with Active Directory</span> in the Office 365 tenant. However, the user is still sourced from the source directory.</p>
      </div>
      <h2>
         <span>Next step</span>
      </h2>
      <p>
         <MadCap:xref href="assign-o365.htm">Assign Office 365 to users and groups</MadCap:xref>
      </p>
   </body>
</html>
