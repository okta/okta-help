<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" MadCap:conditions="MultiProdPublish.Classic+OIE" MadCap:fileTags="Tags/okta-authors.Mark Cowan">
    <head><title>[%=Heading.Level1%] | Okta</title>
    </head>
    <body>
        <h1>Federate multiple Office 365 domains in a single app instance</h1>
        <p>You can automatically federate multiple Microsoft Office 365 domains within a single <MadCap:variable name="Mobile.O365" /> app instance in Okta. This eliminates the need to configure a separate <MadCap:variable name="Mobile.O365" /> app instance for each <MadCap:variable name="Mobile.O365" /> domain.</p>
        <p>This is useful in the following scenarios:</p>
        <ul>
            <li>You have multiple <MadCap:variable name="Mobile.O365" /> domains in a single <MadCap:variable name="Mobile.O365" /> tenant and don't want to create separate app instance for each domain.</li>
            <li>You have multiple <MadCap:variable name="Mobile.O365" /> domains in a single <MadCap:variable name="Mobile.O365" /> tenant and want to apply the same set of policies to all of them.</li>
        </ul>
        <h2>Before you begin</h2>
        <ul>
            <li>This feature isn't available for the manual WS-Federation method.</li>
            <li>
                <p>You need the following:</p>
                <ul>
                    <li>A valid Microsoft <MadCap:variable name="Mobile.O365" /> tenant</li>
                    <li>Verified Microsoft <MadCap:variable name="Mobile.O365" /> domains</li>
                    <li>Office 365 application added to Okta org using automatic WS-Federation</li>
                </ul>
            </li>
        </ul>
        <h2>Start this procedure</h2>
        <p>This procedure includes the following tasks:</p>
        <ol>
            <li>
                <MadCap:xref href="#1.">Configure domains</MadCap:xref>
            </li>
            <li>
                <MadCap:xref href="#2.">Validate federated domains</MadCap:xref>
            </li>
        </ol>
        <h3><a name="1."></a> Configure domains</h3>
        <ol>
            <li>
                <p>In <MadCap:variable name="Mobile.O365" /> application instance, open <span class="menucascade"><span class="uicontrol">Sign On</span><span class="uicontrol">Settings</span></span> in <span class="uicontrol">Edit</span> mode.
            </p>
                <p MadCap:conditions="MultiProdPublish.Classic">
                    <img src="../../../Resources/Images/Office365/multiple-domains.png" class="thumbnail" />
                </p>
            </li>
            <li>In <span class="uicontrol">Sign On Methods</span>, select <span class="uicontrol">WS-Federation</span>.</li>
            <li>Select <span class="uicontrol">Automatic</span> for WS-Federation configuration.</li>
            <li>Click <span class="uicontrol">View Setup Instructions</span>. Procedure to configure <MadCap:variable name="Mobile.O365" /> WS-Federation opens in a new window. </li>
            <li>Refer to the <span class="uicontrol">Prepare your domain</span> for federated authentication section of the procedure to ensure you have correctly prepared your domains for federation.</li>
            <li>Back on the <span class="uicontrol">Sign On</span> tab, enter<span class="uicontrol"> Office 365 Admin Username</span> and <span class="uicontrol">Office 365 Admin Password</span> for your Microsoft Office 365 tenant.</li>
            <li>In <span class="uicontrol">Office 365 Domains</span>, click <span class="uicontrol">Fetch and Select</span> to add verified domains. Verified domains for the <MadCap:variable name="Mobile.O365" /> tenant are displayed.</li>
            <li>Select domains that you want to federate.</li>
            <li>Back on the <span class="uicontrol">Sign On</span> tab, click <span class="uicontrol">Save</span>.</li>
        </ol>
        <h3 MadCap:conditions="Primary.do-not-publish">Manually set up WS-Federation</h3>
        <ul MadCap:conditions="Primary.do-not-publish">
            <li>
                <p>In Office 365 application instance, open <span class="menucascade"><span class="uicontrol">Sign On</span><span class="uicontrol">Settings</span></span> in <span class="uicontrol">Edit</span> mode.</p>
            </li>
            <li>In <span class="uicontrol">Sign On Methods</span>, select <span class="uicontrol">WS-Federation</span>.</li>
            <li>Select <span class="uicontrol">I want to configure WS-Federation myself using PowerShell</span>.</li>
            <li>Click <span class="uicontrol">View Setup Instructions</span>. Procedure to configure Office 365 WS-Federation opens.</li>
            <li>Follow the steps for Configure your domain in the Microsoft Azure Active Directory Module for Windows PowerShell. Repeat for each domain you want to configure.</li>
            <li>Back on the <span class="uicontrol">Sign On</span> tab, click <span class="uicontrol">Save</span>.</li>
        </ul>
        <h3><a name="2."></a> Validate federated domains</h3>
        <ol>
            <li>Sign in to Okta as an end user that belongs to an <MadCap:variable name="Mobile.O365" /> domain you federated.</li>
            <li>Access <MadCap:variable name="Mobile.O365" /> through the End-User Dashboard.</li>
            <li>Ensure you can sign in successfully.</li>
            <li>Repeat these steps for test users from all federated <MadCap:variable name="Mobile.O365" /> domains.
</li>
        </ol>
        <p>Alternatively, you can use the following PowerShell cmdlet for each federated domain to verify that the domain has been successfully federated:</p><span class="code">Get-MSOlDomainFederatioNSettings -domainname &lt;domain name&gt;</span>
        <div MadCap:conditions="Primary.review-only,Primary.do-not-publish">
            <h3>Validate federated domains (Microsoft Graph)</h3>
            <p>If you enabled the MS Graph federation feature, the PowerShell commands are different.</p>
            <ol>
                <li>Sign in to Okta as an end user that belongs to an <MadCap:variable name="Mobile.O365" /> domain you federated.</li>
                <li>Access <MadCap:variable name="Mobile.O365" /> through the End-User Dashboard.</li>
                <li>Ensure you can sign in successfully.</li>
                <li>Repeat these steps for test users from all federated <MadCap:variable name="Mobile.O365" /> domains.
</li>
            </ol>
            <p>Alternatively, you can use the following PowerShell cmdlet for each federated domain to verify that the domain has been successfully federated:</p>
            <p><span class="code">Get-MgDomainFederationConfiguration -DomainId &lt;yourDomainName&gt; | Select -Property FederatedIdpMfaBehavior</span>
            </p>
        </div>
        <h2>Cautions</h2>
        <ul>
            <li>
                <p>Federating a domain with multiple subdomains in a single app causes sign-in errors</p>
                <p>Federating a domain with multiple subdomains in a single app cause the subdomain members to receive an error when they sign in. To avoid this, federate domains manually using PowerShell. See <MadCap:xref href="../Office365-Deployment/configure-sso.htm#Configur3">Configure Single Sign on using WS-Federation - PowerShell method</MadCap:xref>.</p>
            </li>
            <li>
                <p>Switching to manual WS-federation or SWA will unfederate domains</p>
                <p>If you switch from automatic WS-Federation to manual WS-Federation or from WS-Federation to SWA, all the domains involved will be unfederated.</p>
            </li>
            <li>
                <p>Don't delete <MadCap:variable name="Mobile.O365" /> app instances</p>
                <p>If you have multiple instances of <MadCap:variable name="Mobile.O365" /> domains that are automatically federated and you're migrating to a single instance of automatically federated <MadCap:variable name="Mobile.O365" />, disable such instances. Do not delete them.</p>
            </li>
            <li>
                <p>When unfederating, wait until all domains are unfederated</p>
                <p>If you change the federation method from automatic to manual for already-federated domains, Okta recommends that you wait until all automatically federated domains are unfederated. If you try to manually federate a domain before Okta completes its unfederation process, Okta may try to remove the manually federated domain since it was previously an automatically federated domain.</p>
                <p>Use the following cmdlet to ensure that the automatically federated domain is unfederated:</p><span class="code">Get-MSOlDomainFederatioNSettings -domainname &lt;domain name&gt;</span>.<div class="noteOkta" MadCap:conditions="Primary.review-only,Primary.do-not-publish"><p class="noteContent">If you enabled the Microsoft Graph federation feature, the PowerShell commands are different. Use the following cmdlet to ensure that the automatically federated domain is unfederated: <span class="code">Get-MgDomainFederationConfiguration -DomainId &lt;yourDomainName&gt; | Select -Property FederatedIdpMfaBehavior</span>.</p></div><p>You should expect some downtime while the domain is being unfederated.</p></li>
            <li>
                <p>Configure domains during off-hours to avoid assigning duplicate apps</p>
                <p>When you configure an <MadCap:variable name="Mobile.O365" /> domain that's already configured in a separate <MadCap:variable name="Mobile.O365" /> app instance, end users may be assigned a duplicate set of <MadCap:variable name="Mobile.O365" /> apps. Perform this action during off-hours so that you have enough time to unconfigure the original app instance.</p>
            </li>
        </ul>
        <h2 MadCap:conditions="MultiProdPublish.Classic">Related topics</h2>
        <ul>
            <li MadCap:conditions="MultiProdPublish.Classic">
                <MadCap:xref href="../Apps_Configuring WS-Federation.htm">Configuring WS-Federation</MadCap:xref>
            </li>
            <li MadCap:conditions="MultiProdPublish.Classic">
                <MadCap:xref href="../Apps_Moving_Microsoft.htm">Moving Microsoft Office 365 from SWA to WS-Federation</MadCap:xref>
            </li>
            <li MadCap:conditions="MultiProdPublish.Classic">
                <MadCap:xref href="../Apps_Configure_Okta Template_WS_Federation.htm">Configuring the Okta Template WS Federation Application</MadCap:xref>
            </li>
        </ul>
    </body>
</html>